# TCP





![image-20210922184642530](C:\Users\김한비\AppData\Roaming\Typora\typora-user-images\image-20210922184642530.png)



## main server

main server는 음성을 텍스트로 변환하는 STT 모델을 토대로 실시간 음성을 decode 및 rescore하는 작업이 주요 업무다. 

음성이 들어오면 실시간으로 인식한 어절이 가장 먼저 decode 되어 나오고, 그 다음으로 Endpoint를 기준으로 한 문장이 decode 되어 나온다.

decode된 문장이 발생하면 rescoring 함수가 병렬적으로 동작하여 해당 문장을 rescore해서 rescoreStr에 저장해준다.



위와같은 STT관련 작업 뿐만 아니라 TCP 형식의 server역할을 하는데 순서대로 (1) 띄어쓰기 클라이언트, (2) 채팅 클라이언트, (3) TTS 및 감정분석 서버, (4)전화 음성 클라이언트와 연결한다. 각 클라이언트 및 서버는 동작을 위한 사전 준비를 완료하고 서버에 접속한다.



## STT

실제 동작은 전화음성 클라이언트에서 음성을 받아오면서 시작된다. 

전화 음성 클라이언트는 휴대폰과 연결되어 있는 라즈베리 파이에서 실시간으로 전화 음성을 8kHz에서 16kHz로 샘플링하여 main server로 보내준다.

Main server는 사용자가 빠르게 해당 음성을 텍스트로 받을 수 있도록 실시간으로 인식한 어절이 decode될 때마다  채팅 서버에 전송한다. 이후 화자가 다음 문장을 말하기 전에 발생하는 잠깐의 silence를 통해 endpoint를 인식하고 이전 문장을 통으로 decode하는데, 이때 이 decode된 문장은 rescoring 함수, 채팅 클라이언트, 띄어쓰기 클라이언트에 보내지게 된다.

먼저 위에서 기술한 rescoring 함수에서 해당 문장을 rescore한다. 그 다음으로 채팅 클라이언트에서는 실시간으로 받아왔던 어절들을 decode된 문장으로 덮어 씌우고, 띄어쓰기 클라이언트에서는 해당 문장의 띄어쓰기를 보정한다. 채팅 클라이언트와 띄어쓰기 클라이언트에서는 해당 문장이 디코드 된 문장인지, 몇 번째로 발생한 문장인지 등이 중요하기 때문에 T{num}의 형식으로 문장 앞에 토큰을 붙여 보내준다.

띄어쓰기 클라이언트에서는 문장을 받아와서 앞에 붙은 토큰은 떼어내고 문장에 대해서만 띄어쓰기 교정을 진행한다. 교정이 완료되면 T토큰을 C토큰으로 변경한 후 main server를 거쳐 채팅 클라이언트에 전달한다. 채팅 클라이언트는 C토큰을 가진 문장이 들어오면 이전 문장 대신 해당 문장을 {num}에 맞는 라인에 띄운다.

한편 Rescoring함수에서 decode문장이 rescore되어 나오면 이 문장에 R{num}토큰을 붙여서 띄어쓰기 클라이언트에 보내준다. 그럼 띄어쓰기 서버에서는 다시 토큰을 떼서 띄어쓰기를 교정한 후 R토큰을 D토큰으로 바꿔서 main server를 거쳐 채팅 클라이언트에 보낸다. 채팅 클라이언트는 최종적으로 rescore과 띄어쓰기를 모두 거친 D토큰의 문장을 화면에 띄우게 된다.



## TTS

사용자가 점주에게 말하고 싶은 내용이 생기면 채팅 클라이언트의 UI에서 텍스트를 작성하여 main server에 전송하고 서버에서는 이를 곧바로 TTS 및 감정분석 서버에 넘겨준다. TTS 및 감정분석 서버에서는 해당 텍스트를 먼저 감정분석 모델에 넣어 텍스트가 담고 있는 감정(일상, 행복, 분노, 슬픔) 을 찾아내고 TTS 모델을 이용해 해당 감정을 나타내는 억양으로 텍스트를 wav형식의 음성으로 변환한다. 이를 byte형식으로 TTS receive 클라이언트에게 전송하면 TTS receive 클라이언트는 byte형식을 다시 wav로 변환해 TTS sound를 재생시키고 이는 휴대폰의 마이크로 넘어가 점주에게 전달된다.



